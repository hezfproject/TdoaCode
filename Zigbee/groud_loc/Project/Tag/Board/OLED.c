/******************************************************************************
 Copyright 2011, Walasey Technologies
 Author: WangKun
******************************************************************************/

#include "OLED.h"
#include "CPU.h"

#ifdef ENABLE_OLED

#define SCREEN_OFFSET_X     2

//-----------------------------------------------------------------------------

#define ENABLE_DISP_BUFFER

#ifdef ENABLE_DISP_BUFFER

	static NtrxBufferType OLED_DispBuffer[64] ;

	static void OLED_ClearBuffer( void )
	{
		uint8 i ;
		for( i = 0 ; i < 64 ; i ++ )
			OLED_DispBuffer[i] = 0 ;
	}

#endif

//-----------------------------------------------------------------------------
// !"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz{|}~

const NtrxFlashCode OLED_FontsTable[] =
{
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	//  
	0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xCC,0x0C,0x00,0x00,0x00,	// !
	0x00,0x08,0x30,0x60,0x08,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// "
	0x02,0x03,0x1E,0x02,0x03,0x1E,0x02,0x00,0x20,0xFC,0x20,0x20,0xFC,0x20,0x20,0x00,	// #
	0x00,0x0E,0x11,0x3F,0x10,0x0C,0x00,0x00,0x00,0x18,0x04,0xFF,0x84,0x78,0x00,0x00,	// $
	0x0F,0x10,0x0F,0x00,0x07,0x18,0x00,0x00,0x00,0x84,0x38,0xC0,0x78,0x84,0x78,0x00,	// %
	0x00,0x0F,0x10,0x11,0x0E,0x00,0x00,0x00,0x78,0x84,0xC4,0x24,0x98,0xE4,0x84,0x08,	// &
	0x08,0x68,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// '
	0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00,0x00,0x00,0x00,0xE0,0x18,0x04,0x02,0x00,	// (
	0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00,0x00,0x02,0x04,0x18,0xE0,0x00,0x00,0x00,	// )
	0x02,0x02,0x01,0x0F,0x01,0x02,0x02,0x00,0x40,0x40,0x80,0xF0,0x80,0x40,0x40,0x00,	// *
	0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0xF8,0x80,0x80,0x80,0x00,	// +
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0D,0x0E,0x00,0x00,0x00,0x00,0x00,	// ,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,	// -
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x00,0x00,0x00,0x00,0x00,	// .
	0x00,0x00,0x00,0x00,0x01,0x06,0x18,0x20,0x00,0x06,0x18,0x60,0x80,0x00,0x00,0x00,	// /
	0x00,0x07,0x08,0x10,0x10,0x08,0x07,0x00,0x00,0xF0,0x08,0x04,0x04,0x08,0xF0,0x00,	// 0
	0x00,0x08,0x08,0x1F,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0xFC,0x04,0x04,0x00,0x00,	// 1
	0x00,0x0E,0x10,0x10,0x10,0x11,0x0E,0x00,0x00,0x0C,0x14,0x24,0x44,0x84,0x0C,0x00,	// 2
	0x00,0x0C,0x10,0x11,0x11,0x12,0x0C,0x00,0x00,0x18,0x04,0x04,0x04,0x88,0x70,0x00,	// 3
	0x00,0x00,0x03,0x04,0x08,0x1F,0x00,0x00,0x00,0xE0,0x20,0x24,0x24,0xFC,0x24,0x00,	// 4
	0x00,0x1F,0x10,0x11,0x11,0x10,0x10,0x00,0x00,0x98,0x84,0x04,0x04,0x88,0x70,0x00,	// 5
	0x00,0x07,0x08,0x11,0x11,0x18,0x00,0x00,0x00,0xF0,0x88,0x04,0x04,0x88,0x70,0x00,	// 6
	0x00,0x1C,0x10,0x10,0x13,0x1C,0x10,0x00,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,	// 7
	0x00,0x0E,0x11,0x10,0x10,0x11,0x0E,0x00,0x00,0x38,0x44,0x84,0x84,0x44,0x38,0x00,	// 8
	0x00,0x07,0x08,0x10,0x10,0x08,0x07,0x00,0x00,0x00,0x8C,0x44,0x44,0x88,0xF0,0x00,	// 9
	0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x00,0x00,0x00,	// :
	0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x00,0x00,0x00,0x00,	// ;
	0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x04,0x00,	// <
	0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x00,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x00,	// =
	0x00,0x10,0x08,0x04,0x02,0x01,0x00,0x00,0x00,0x04,0x08,0x10,0x20,0x40,0x80,0x00,	// >
	0x00,0x0E,0x12,0x10,0x10,0x10,0x0F,0x00,0x00,0x00,0x00,0x0C,0x6C,0x80,0x00,0x00,	// ?
	0x03,0x0C,0x13,0x14,0x17,0x08,0x07,0x00,0xE0,0x18,0xE4,0x24,0xC4,0x28,0xD0,0x00,	// @
	0x00,0x00,0x03,0x1C,0x07,0x00,0x00,0x00,0x04,0x3C,0xC4,0x40,0x40,0xE4,0x1C,0x04,	// A
	0x10,0x1F,0x11,0x11,0x11,0x0E,0x00,0x00,0x04,0xFC,0x04,0x04,0x04,0x88,0x70,0x00,	// B
	0x03,0x0C,0x10,0x10,0x10,0x10,0x1C,0x00,0xE0,0x18,0x04,0x04,0x04,0x08,0x10,0x00,	// C
	0x10,0x1F,0x10,0x10,0x10,0x08,0x07,0x00,0x04,0xFC,0x04,0x04,0x04,0x08,0xF0,0x00,	// D
	0x10,0x1F,0x11,0x11,0x17,0x10,0x08,0x00,0x04,0xFC,0x04,0x04,0xC4,0x04,0x18,0x00,	// E
	0x10,0x1F,0x11,0x11,0x17,0x10,0x08,0x00,0x04,0xFC,0x04,0x00,0xC0,0x00,0x00,0x00,	// F
	0x03,0x0C,0x10,0x10,0x10,0x1C,0x00,0x00,0xE0,0x18,0x04,0x04,0x44,0x78,0x40,0x00,	// G
	0x10,0x1F,0x10,0x00,0x00,0x10,0x1F,0x10,0x04,0xFC,0x84,0x80,0x80,0x84,0xFC,0x04,	// H
	0x00,0x10,0x10,0x1F,0x10,0x10,0x00,0x00,0x00,0x04,0x04,0xFC,0x04,0x04,0x00,0x00,	// I
	0x00,0x00,0x10,0x10,0x1F,0x10,0x10,0x00,0x03,0x01,0x01,0x01,0xFE,0x00,0x00,0x00,	// J
	0x10,0x1F,0x11,0x03,0x14,0x18,0x10,0x00,0x04,0xFC,0x04,0x80,0x64,0x1C,0x04,0x00,	// K
	0x10,0x1F,0x10,0x00,0x00,0x00,0x00,0x00,0x04,0xFC,0x04,0x04,0x04,0x04,0x0C,0x00,	// L
	0x10,0x1F,0x1F,0x00,0x1F,0x1F,0x10,0x00,0x04,0xFC,0x00,0xFC,0x00,0xFC,0x04,0x00,	// M
	0x10,0x1F,0x0C,0x03,0x00,0x10,0x1F,0x10,0x04,0xFC,0x04,0x00,0xE0,0x18,0xFC,0x00,	// N
	0x07,0x08,0x10,0x10,0x10,0x08,0x07,0x00,0xF0,0x08,0x04,0x04,0x04,0x08,0xF0,0x00,	// O
	0x10,0x1F,0x10,0x10,0x10,0x10,0x0F,0x00,0x04,0xFC,0x84,0x80,0x80,0x80,0x00,0x00,	// P
	0x07,0x08,0x10,0x10,0x10,0x08,0x07,0x00,0xF0,0x18,0x24,0x24,0x1C,0x0A,0xF2,0x00,	// Q
	0x10,0x1F,0x11,0x11,0x11,0x11,0x0E,0x00,0x04,0xFC,0x04,0x00,0xC0,0x30,0x0C,0x04,	// R
	0x00,0x0E,0x11,0x10,0x10,0x10,0x1C,0x00,0x00,0x1C,0x04,0x84,0x84,0x44,0x38,0x00,	// S
	0x18,0x10,0x10,0x1F,0x10,0x10,0x18,0x00,0x00,0x00,0x04,0xFC,0x04,0x00,0x00,0x00,	// T
	0x10,0x1F,0x10,0x00,0x00,0x10,0x1F,0x10,0x00,0xF8,0x04,0x04,0x04,0x04,0xF8,0x00,	// U
	0x10,0x1E,0x11,0x00,0x00,0x13,0x1C,0x10,0x00,0x00,0xE0,0x1C,0x70,0x80,0x00,0x00,	// V
	0x1F,0x10,0x00,0x1F,0x00,0x10,0x1F,0x00,0xC0,0x3C,0xE0,0x00,0xE0,0x3C,0xC0,0x00,	// W
	0x10,0x18,0x16,0x01,0x01,0x16,0x18,0x10,0x04,0x0C,0x34,0xC0,0xC0,0x34,0x0C,0x04,	// X
	0x10,0x1C,0x13,0x00,0x13,0x1C,0x10,0x00,0x00,0x00,0x04,0xFC,0x04,0x00,0x00,0x00,	// Y
	0x08,0x10,0x10,0x10,0x13,0x1C,0x10,0x00,0x04,0x1C,0x64,0x84,0x04,0x04,0x18,0x00,	// Z
	0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0xFE,0x02,0x02,0x02,0x00,	// [
	0x00,0x30,0x0C,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0x1C,0x03,0x00,	//
	0x00,0x40,0x40,0x40,0x7F,0x00,0x00,0x00,0x00,0x02,0x02,0x02,0xFE,0x00,0x00,0x00,	// ]
	0x00,0x00,0x20,0x40,0x40,0x40,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// ^
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,	// _
	0x00,0x40,0x40,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// `
	0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x98,0x24,0x44,0x44,0x44,0xFC,0x04,	// a
	0x10,0x1F,0x00,0x01,0x01,0x00,0x00,0x00,0x00,0xFC,0x88,0x04,0x04,0x88,0x70,0x00,	// b
	0x00,0x00,0x00,0x01,0x01,0x01,0x00,0x00,0x00,0x70,0x88,0x04,0x04,0x04,0x88,0x00,	// c
	0x00,0x00,0x00,0x01,0x01,0x11,0x1F,0x00,0x00,0x70,0x88,0x04,0x04,0x08,0xFC,0x04,	// d
	0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0xF8,0x44,0x44,0x44,0x44,0xC8,0x00,	// e
	0x00,0x01,0x01,0x0F,0x11,0x11,0x11,0x18,0x00,0x04,0x04,0xFC,0x04,0x04,0x00,0x00,	// f
	0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0xD6,0x29,0x29,0x29,0xC9,0x06,0x00,	// g
	0x10,0x1F,0x00,0x01,0x01,0x01,0x00,0x00,0x04,0xFC,0x84,0x00,0x00,0x04,0xFC,0x04,	// h
	0x00,0x01,0x19,0x19,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0xFC,0x04,0x04,0x00,0x00,	// i
	0x00,0x00,0x00,0x01,0x19,0x19,0x00,0x00,0x00,0x03,0x01,0x01,0x01,0xFE,0x00,0x00,	// j
	0x10,0x1F,0x00,0x00,0x01,0x01,0x01,0x00,0x04,0xFC,0x24,0x40,0xB4,0x0C,0x04,0x00,	// k
	0x00,0x10,0x10,0x1F,0x00,0x00,0x00,0x00,0x00,0x04,0x04,0xFC,0x04,0x04,0x00,0x00,	// l
	0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x04,0xFC,0x04,0x00,0xFC,0x04,0x00,0xFC,	// m
	0x01,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x04,0xFC,0x84,0x00,0x00,0x04,0xFC,0x04,	// n
	0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0xF8,0x04,0x04,0x04,0x04,0xF8,0x00,	// o
	0x01,0x01,0x00,0x01,0x01,0x00,0x00,0x00,0x01,0xFF,0x85,0x04,0x04,0x88,0x70,0x00,	// p
	0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00,0x70,0x88,0x04,0x04,0x05,0xFF,0x01,	// q
	0x01,0x01,0x01,0x00,0x01,0x01,0x01,0x00,0x04,0x04,0xFC,0x84,0x04,0x00,0x80,0x00,	// r
	0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0xCC,0x24,0x24,0x24,0x24,0x98,0x00,	// s
	0x00,0x01,0x01,0x07,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0xF8,0x04,0x04,0x00,0x00,	// t
	0x01,0x01,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0xF8,0x04,0x04,0x04,0x08,0xFC,0x04,	// u
	0x01,0x01,0x01,0x00,0x00,0x01,0x01,0x01,0x00,0x80,0x70,0x0C,0x10,0x60,0x80,0x00,	// v
	0x01,0x01,0x00,0x01,0x00,0x01,0x01,0x01,0xF0,0x0C,0x30,0xC0,0x30,0x0C,0xF0,0x00,	// w
	0x00,0x01,0x01,0x00,0x01,0x01,0x01,0x00,0x00,0x04,0x8C,0x74,0x70,0x8C,0x04,0x00,	// x
	0x01,0x01,0x01,0x00,0x00,0x01,0x01,0x01,0x01,0x81,0x71,0x0E,0x18,0x60,0x80,0x00,	// y
	0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x84,0x0C,0x34,0x44,0x84,0x0C,0x00,	// z
	0x00,0x00,0x00,0x00,0x01,0x3E,0x40,0x40,0x00,0x00,0x00,0x00,0x00,0xFC,0x02,0x02,	// {
	0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,	// |
	0x00,0x40,0x40,0x3E,0x01,0x00,0x00,0x00,0x00,0x02,0x02,0xFC,0x00,0x00,0x00,0x00,	// }
	0x00,0x60,0x80,0x80,0x40,0x40,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	// ~
} ;

//-----------------------------------------------------------------------------

static void OLED_SendByte( uint8 c )
{
	uint8 i ;

	OLED_ClrCS() ;
	for( i = 0x80 ; i > 0 ; i >>= 1 )
	{
		OLED_ClrSCL() ;
		if( c & i )
			OLED_SetSI() ;
		else
			OLED_ClrSI() ;
		OLED_SetSCL() ;
	}
	OLED_SetCS() ;
}

static void OLED_WriteCommand( uint8 Cmd )
{
	OLED_SetCS() ;
	OLED_ClrA0() ;
	OLED_SendByte( Cmd ) ;
}

static void OLED_WriteData( uint8 Dat )
{
	OLED_SetCS() ;
	OLED_SetA0() ;
	OLED_SendByte( Dat ) ;
}

//-----------------------------------------------------------------------------

static void OLED_DCDC_On( void )
{
	OLED_WriteCommand( 0xAD ) ; /* Set DC-DC */
	OLED_WriteCommand( 0x8B ) ; /* 8B=ON, 8A=Off */
}

static void OLED_DCDC_Off( void )
{
	OLED_WriteCommand( 0xAD ) ; /* Set DC-DC */
	OLED_WriteCommand( 0x8A ) ; /* 8B=ON, 8A=Off */
}

static void OLED_DisplayOn( void )
{
	OLED_WriteCommand( 0xAF ) ;
}

static void OLED_DisplayOff( void )
{
	OLED_WriteCommand( 0xAE ) ; 
}

static void OLED_SetContrast( uint8 c )
{
	OLED_WriteCommand( 0x81 ) ; 
	OLED_WriteCommand( c ) ; 
}

//-----------------------------------------------------------------------------

void OLED_PutChar( uint8 x, uint8 y, uint8 c )
{
	uint8 i ;
	const NtrxFlashCode *Addr ;

	#ifdef ENABLE_DISP_BUFFER
		if( OLED_DispBuffer[(y<<4)+x] == c )
			return ;
		OLED_DispBuffer[(y<<4)+x] = c ;
	#endif

	if( ( c < 0x20 ) || ( c > 0x7F ) )
		c = 0x20 ;
	c -= 0x20 ;

	Addr = OLED_FontsTable + ((uint16)c<<4) ;

	OLED_WriteCommand( 0xB7-y*2 ) ;
	if( x & 1 )
		OLED_WriteCommand( 0x08+SCREEN_OFFSET_X ) ;
	else
		OLED_WriteCommand( 0x00+SCREEN_OFFSET_X ) ;
	OLED_WriteCommand( 0x10+x/2 ) ;
	for( i = 0 ; i < 8 ; i ++ )
		OLED_WriteData( NtrxReadFlash( Addr + i ) ) ;                     

	OLED_WriteCommand( 0xB6-y*2 ) ;
	if( x & 1 )
		OLED_WriteCommand( 0x08+SCREEN_OFFSET_X ) ;
	else
		OLED_WriteCommand( 0x00+SCREEN_OFFSET_X ) ;
	OLED_WriteCommand( 0x10+x/2 ) ;
	for( i = 8 ; i < 16 ; i ++ )
		OLED_WriteData( NtrxReadFlash( Addr + i ) ) ;                     
}

//-----------------------------------------------------------------------------

void OLED_PutString( uint8 x, uint8 y, const NtrxFlashCode *ptr )
{
	uint8 c ;
	while( 1 )
	{
		while( x > 15 )
		{
			x -= 16 ;
			y ++ ;
		}
		if( y > 3 )
			return ;
		c = NtrxReadFlash( ptr ) ;
		if( ! c )
			return ;
		if( c == '\n' )
		{
			while( x < 16 )
				OLED_PutChar( x++, y, ' ' ) ;
			x = 0 ;
			y ++ ;
		}
		else
			OLED_PutChar( x++, y, c ) ;
		ptr ++ ;
	}
}

//-----------------------------------------------------------------------------

void OLED_Clear( void )
{
	uint8 i ;
	for( i = 0 ; i < 64 ; i ++ )
		OLED_PutChar( i & 15, i >> 4, ' ' ) ;
}

//-----------------------------------------------------------------------------

void OLED_Init( void )
{
	WatchdogReset() ;

	// ? 命令似乎可以在RESET期间送出,RESET前关闭显示,对策开机显示闪烁
	OLED_DCDC_Off() ;
	OLED_DisplayOff() ;

	// Reset
	Delay_ms( 5 ) ;
	OLED_ClrRES() ;
	Delay_ms( 150 ) ;
	OLED_SetRES() ;
	Delay_ms( 5 ) ;

	OLED_DCDC_Off() ;
	OLED_DisplayOff() ;

	// Reset Again
	Delay_ms( 5 ) ;
	OLED_ClrRES() ;
	Delay_ms( 10 ) ;
	OLED_SetRES() ;
	Delay_ms( 5 ) ;

	// Init
	OLED_WriteCommand( 0x40 ) ; // Display start line:0
	OLED_SetContrast ( 0x3F ) ; // Contrast control mode:47
	OLED_WriteCommand( 0xA1 ) ; // [A1] 显示内容左右翻转, [A0] 不翻转
	OLED_WriteCommand( 0xA4 ) ; // [A4] Normal display  [A5] Entire display
	OLED_WriteCommand( 0xA6 ) ; // [A6] Normal display  [A7] Reverse display
	OLED_WriteCommand( 0xA8 ) ; // Set Multiplex Ratio = 63
	OLED_WriteCommand( 0x3F ) ;

	OLED_WriteCommand( 0xD3 ) ; // Vertical display offset = 0
	OLED_WriteCommand( 0x00 ) ; 
	OLED_WriteCommand( 0xD5 ) ; // Set Clock Divide to 80Hz
	OLED_WriteCommand( 0x20 ) ; 
	OLED_WriteCommand( 0xD8 ) ; // Set Area Color On or Off
	OLED_WriteCommand( 0x00 ) ;
	OLED_WriteCommand( 0xDA ) ; // Set Pins HardwareConfiguration 
	OLED_WriteCommand( 0x12 ) ;
	OLED_WriteCommand( 0xDB ) ; // Set VCOMH = 0
	OLED_WriteCommand( 0x00 ) ;
	OLED_WriteCommand( 0xD9 ) ; // Set VP = 0x22
	OLED_WriteCommand( 0x22 ) ; 
	OLED_WriteCommand( 0xC0 ) ; // [C0] 显示内容上下翻转 [C8] 不翻转

	#ifdef ENABLE_DISP_BUFFER
		OLED_ClearBuffer() ;
	#endif

	OLED_Clear() ;              // Clear display ram

	OLED_DCDC_On() ;
	Delay_ms( 100 ) ;           // Wait DC-DC stable
	OLED_DisplayOn() ;
	Delay_ms( 150 ) ;

}

//-----------------------------------------------------------------------------

void OLED_TurnOff( void )
{
	OLED_DisplayOff() ;
	OLED_DCDC_Off() ;
	Delay_ms( 100 ) ;
}

//=============================================================================

#endif // ENABLE_OLED


