###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.60.1.40026 for 8051             23/Oct/2018  17:27:15 #
# Copyright (C) 2004-2010 IAR Systems AB.                                     #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  E:\p4\main\Zigbee\cc2530\mine_project_voice\third_ #
#                          party\TIMAC-CC2530-1.3.1\Components\mac\low_level\ #
#                          srf04\mac_autopend.c                               #
#    Command line       =  E:\p4\main\Zigbee\cc2530\mine_project_voice\third_ #
#                          party\TIMAC-CC2530-1.3.1\Components\mac\low_level\ #
#                          srf04\mac_autopend.c -D xSMS_TEMPLATE -D           #
#                          MENU_CLOCKFORMAT -D CELLSWITCH_DEBUG -D            #
#                          MP_INFORMATION -D HOLD_AUTO_START -D SMS_SENDBOX   #
#                          -D NEW_MENU_LIB -D WATCHDOG=TRUE -D                #
#                          NEW_DOUBLE_NVID_OP -D AUDIO_SERIAL -D              #
#                          NWK_AUTO_POLL -D OSC32K_CRYSTAL_INSTALLED=FALSE    #
#                          -D xAUDIO_TEST -D xSINGLE_AUDIO_TEST -D            #
#                          xMULTIAUDIO_TEST -D xREFLECTOR -D xLCD_SUPPORTED   #
#                          -D HAL_LCD=FALSE -D HAL_AUDIO=TRUE -D              #
#                          HAL_SPI=FALSE -D HAL_UART=FALSE -D HAL_LED=FALSE   #
#                          -D HAL_AES=FALSE -D HAL_KEY=TRUE -D                #
#                          IDX_THRESHOLD=12 -D xMACNODEBUG -D                 #
#                          xMAC_NO_PARAM_CHECK -D HAL_AUDIO=TRUE -D           #
#                          HAL_DMA=TRUE -D HAL_AES=FALSE -D                   #
#                          MAC_CFG_TX_DATA_MAX=8 -D MAC_CFG_TX_MAX=12 -D      #
#                          MAC_CFG_RX_MAX=8 -lcN E:\p4\main\Zigbee\cc2530\min #
#                          e_project_voice\app\MobilePhone\iar\Release\List\  #
#                          -lb E:\p4\main\Zigbee\cc2530\mine_project_voice\ap #
#                          p\MobilePhone\iar\Release\List\ -o                 #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\Release\Obj\ -e                      #
#                          --require_prototypes --no_unroll --no_inline       #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I E:\p4\main\Zigbee\cc2530\mine_project_voice\app #
#                          \MobilePhone\iar\..\src\ -I                        #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\src\MenuLib\ -I                   #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\src\MenuLib\util\ -I              #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\MAC\INCLUDE\ -I                     #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\MAC\HIGH_LEVEL\ -I                  #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\MAC\LOW_LEVEL\ -I                   #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\MAC\LOW_LEVEL\SRF04\ -I             #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\MAC\LOW_LEVEL\SRF04\SINGLE_CHIP\    #
#                          -I E:\p4\main\Zigbee\cc2530\mine_project_voice\app #
#                          \MobilePhone\iar\..\..\..\third_party\TIMAC-CC2530 #
#                          -1.3.1\COMPONENTS\OSAL\INCLUDE\ -I                 #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\OSAL\MCU\CC2530\ -I                 #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\SERVICES\SADDR\ -I                  #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\SERVICES\SDATA\ -I                  #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\third_party\TIMAC-CC2530-1. #
#                          3.1\COMPONENTS\MT\ -I E:\p4\main\Zigbee\cc2530\min #
#                          e_project_voice\app\MobilePhone\iar\..\..\..\..\.. #
#                          \..\common\ -I E:\p4\main\Zigbee\cc2530\mine_proje #
#                          ct_voice\app\MobilePhone\iar\..\..\..\..\..\common #
#                          \lcd\ -I E:\p4\main\Zigbee\cc2530\mine_project_voi #
#                          ce\app\MobilePhone\iar\..\..\..\..\..\..\common\2g #
#                          \ -I E:\p4\main\Zigbee\cc2530\mine_project_voice\a #
#                          pp\MobilePhone\iar\..\..\..\..\..\..\ -I           #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\driver\ -I                  #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\util\ -I                    #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\driver\include\ -I          #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\driver\common\ -I           #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\driver\MobilePhone\ -I      #
#                          E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\..\..\..\driver\MobilePhone\audio\   #
#                          -I E:\p4\main\Zigbee\cc2530\mine_project_voice\app #
#                          \MobilePhone\iar\..\..\..\driver\MobilePhone\commo #
#                          n\ -I E:\p4\main\Zigbee\cc2530\mine_project_voice\ #
#                          app\MobilePhone\iar\..\..\..\driver\MobilePhone\ke #
#                          y\ -I E:\p4\main\Zigbee\cc2530\mine_project_voice\ #
#                          app\MobilePhone\iar\..\..\..\driver\MobilePhone\lc #
#                          d\ -I E:\p4\main\Zigbee\cc2530\mine_project_voice\ #
#                          app\MobilePhone\iar\..\..\..\driver\MobilePhone\io #
#                          expand\ -I "C:\Program Files\IAR Systems\Embedded  #
#                          Workbench 5.4\8051\INC\" -I "C:\Program Files\IAR  #
#                          Systems\Embedded Workbench 5.4\8051\INC\CLIB\"     #
#                          -Ohs                                               #
#    List file          =  E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\Release\List\mac_autopend.lst        #
#    Object file        =  E:\p4\main\Zigbee\cc2530\mine_project_voice\app\Mo #
#                          bilePhone\iar\Release\Obj\mac_autopend.r51         #
#                                                                             #
#                                                                             #
###############################################################################

E:\p4\main\Zigbee\cc2530\mine_project_voice\third_party\TIMAC-CC2530-1.3.1\Components\mac\low_level\srf04\mac_autopend.c
      1          /**************************************************************************************************
      2            Filename:       mac_autopend.c
      3            Revised:        $Date: 2011/03/14 18:43:37 $
      4            Revision:       $Revision: 1.1 $
      5          
      6            Description:    This file implements the TIMAC Autopend feature.
      7          
      8          
      9            Copyright 2006-2009 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /* low-level */
     41          #include "mac_api.h"
     42          #include "mac_radio_defs.h"
     43          
     44          /* osal */
     45          #include "OSAL.h"
     46          #include "saddr.h"
     47          #include "ZComDef.h"
     48          
     49          #include "mac_autopend.h"
     50          
     51          /* ------------------------------------------------------------------------------------------------
     52           *                                           Defines
     53           * ------------------------------------------------------------------------------------------------
     54           */
     55          #define MAC_SRCMATCH_INVALID_INDEX           0xFF
     56          
     57          #define MAC_SRCMATCH_SHORT_ENTRY_SIZE        4
     58          #define MAC_SRCMATCH_EXT_ENTRY_SIZE          Z_EXTADDR_LEN
     59          
     60          #define MAC_SRCMATCH_SHORT_MAX_NUM_ENTRIES   24
     61          #define MAC_SRCMATCH_EXT_MAX_NUM_ENTRIES     12
     62          
     63          #define MAC_SRCMATCH_ENABLE_BITMAP_LEN       3
     64                    
     65          /* ------------------------------------------------------------------------------------------------
     66           *                                      Global Variables
     67           * ------------------------------------------------------------------------------------------------
     68           */
     69          bool macSrcMatchIsEnabled = FALSE; 
     70          
     71          /* ------------------------------------------------------------------------------------------------
     72           *                                         Local Variables
     73           * ------------------------------------------------------------------------------------------------
     74           */
     75          
     76          /* 
     77           The following local Varables are only set in MAC_SrcMatchEnable()  
     78           They are read only to the rest of the module.
     79           */
     80          uint8 macSrcMatchMaxNumEntries = 0;   
     81          uint8 macSrcMatchAddrMode = SADDR_MODE_SHORT;  
     82          bool macSrcMatchIsAckAllPending = FALSE;
     83          
     84          /* ------------------------------------------------------------------------------------------------
     85           *                                         Local Functions
     86           * ------------------------------------------------------------------------------------------------
     87           */
     88          static uint8 macSrcMatchFindEmptyEntry( void );
     89          static uint8 macSrcMatchCheckSrcAddr ( sAddr_t *addr, uint16 panID  );
     90          static void macSrcMatchSetPendEnBit( uint8 index );
     91          static void macSrcMatchSetEnableBit( uint8 index, bool option );
     92          static bool macSrcMatchCheckEnableBit( uint8 index );
     93          static uint24 macSrcMatchGetEnableBit( void );
     94          static uint24 macSrcMatchGetPendEnBit( void );
     95          
     96          /*********************************************************************
     97           * @fn          MAC_SrcMatchEnable
     98           *
     99           * @brief      Enabled AUTOPEND and source address matching. If number of source
    100           *             address table entries asked for is more than the hardware
    101           *             supports. It will allocate maximum number of entries and return 
    102           *             MAC_INVALID_PARAMETER. This function shall be not be called from 
    103           *             ISR. It is not thread safe.
    104           *
    105           * @param      addressType - address type that the application uses
    106           *                           SADDR_MODE_SHORT or SADDR_MODE_EXT
    107           * @param      num - number of source address table entries to be used
    108           *
    109           * @return     MAC_SUCCESS or MAC_INVALID_PARAMETER
    110           */
    111          uint8 MAC_SrcMatchEnable ( uint8 addrType, uint8 num  )
    112          {
    113            uint8 rtn;
    114            uint8 maxNum;
    115              
    116            /* Verify the address type */
    117            if( addrType != SADDR_MODE_SHORT && addrType != SADDR_MODE_EXT )
    118            {
    119              return MAC_INVALID_PARAMETER;
    120            }
    121            
    122            maxNum = ( addrType == SADDR_MODE_SHORT ) ? 
    123                     MAC_SRCMATCH_SHORT_MAX_NUM_ENTRIES : MAC_SRCMATCH_EXT_MAX_NUM_ENTRIES;
    124                     
    125            if( num > maxNum )
    126            {
    127              rtn = MAC_INVALID_PARAMETER;
    128              num = maxNum;
    129            }
    130            else
    131            {
    132              rtn = MAC_SUCCESS;
    133            }
    134              
    135            /* Turn on Frame Filter (TIMAC enables frame filter by default), TBD */
    136            MAC_RADIO_TURN_ON_RX_FRAME_FILTERING();
    137            
    138            /* Turn on Auto ACK (TIMAC turn on Auto ACK by default), TBD */
    139            MAC_RADIO_TURN_ON_AUTO_ACK();
    140            
    141            /* Turn on Autopend: set SRCMATCH.AUTOPEND and SRCMATCH.SRC_MATCH_EN */
    142            MAC_RADIO_TURN_ON_SRC_MATCH();
    143           
    144            /* Set SRCMATCH.AUTOPEND */
    145            MAC_RADIO_TURN_ON_AUTOPEND();
    146            
    147            /* Configure all the globals */
    148            macSrcMatchIsEnabled = TRUE;
    149            macSrcMatchMaxNumEntries = num;
    150            macSrcMatchAddrMode = addrType;           
    151          
    152            return rtn;
    153          }
    154          
    155          /*********************************************************************
    156           * @fn          MAC_SrcMatchAddEntry
    157           *
    158           * @brief       Add a short or extended address to source address table. This 
    159           *              function shall be not be called from ISR. It is not thread safe.
    160           *
    161           * @param       addr - a pointer to sAddr_t which contains addrMode 
    162           *                     and a union of a short 16-bit MAC address or an extended 
    163           *                     64-bit MAC address to be added to the source address table. 
    164           * @param       panID - the device PAN ID. It is only used when the addr is 
    165           *                      using short address 
    166          
    167           * @return      MAC_SUCCESS or MAC_NO_RESOURCES (source address table full) 
    168           *              or MAC_DUPLICATED_ENTRY (the entry added is duplicated),
    169           *              or MAC_INVALID_PARAMETER if the input parameters are invalid.
    170           */
    171          uint8 MAC_SrcMatchAddEntry ( sAddr_t *addr, uint16 panID )
    172          {
    173            uint8 index;
    174            uint8 entry[MAC_SRCMATCH_SHORT_ENTRY_SIZE];
    175            
    176            /* Check if the input parameters are valid */
    177            if ( addr == NULL || addr->addrMode != macSrcMatchAddrMode )
    178            {
    179              return MAC_INVALID_PARAMETER;  
    180            }
    181            
    182            /* Check if the entry already exists. Do not add duplicated entry */
    183            if ( macSrcMatchCheckSrcAddr( addr, panID ) != MAC_SRCMATCH_INVALID_INDEX )
    184            {
    185              return MAC_DUPLICATED_ENTRY; 
    186            }
    187            
    188            /* If not duplicated, write to the radio RAM and enable the control bit */
    189            
    190            /* Find the first empty entry */
    191            index = macSrcMatchFindEmptyEntry();
    192            if ( index == macSrcMatchMaxNumEntries )
    193            {
    194              return MAC_NO_RESOURCES;   /* Table is full */
    195            }
    196            
    197            if ( macSrcMatchAddrMode == SADDR_MODE_SHORT )
    198            {
    199              /* Write the PanID and short address */
    200              entry[0] = LO_UINT16( panID );  /* Little Endian for the radio RAM */
    201              entry[1] = HI_UINT16( panID );
    202              entry[2] = LO_UINT16( addr->addr.shortAddr );
    203              entry[3] = HI_UINT16( addr->addr.shortAddr );
    204              MAC_RADIO_SRC_MATCH_TABLE_WRITE( ( index * MAC_SRCMATCH_SHORT_ENTRY_SIZE ), 
    205                             entry, MAC_SRCMATCH_SHORT_ENTRY_SIZE );
    206            }
    207            else
    208            {
    209              /* Write the extended address */
    210              MAC_RADIO_SRC_MATCH_TABLE_WRITE( ( index * MAC_SRCMATCH_EXT_ENTRY_SIZE ), 
    211                             addr->addr.extAddr, MAC_SRCMATCH_EXT_ENTRY_SIZE ); 
    212            }
    213            
    214            /* Set the Autopend enable bits */
    215            macSrcMatchSetPendEnBit( index );
    216            
    217            /* Set the Src Match enable bits */
    218            macSrcMatchSetEnableBit( index, TRUE );
    219            
    220            return MAC_SUCCESS;
    221          }
    222          
    223          /*********************************************************************
    224           * @fn         MAC_SrcMatchDeleteEntry
    225           *
    226           * @brief      Delete a short or extended address from source address table. 
    227           *             This function shall be not be called from ISR. It is not thread safe.
    228           *
    229           * @param      addr - a pointer to sAddr_t which contains addrMode 
    230           *                    and a union of a short 16-bit MAC address or an extended 
    231           *                    64-bit MAC address to be deleted from the source address table. 
    232           * @param      panID - the device PAN ID. It is only used when the addr is 
    233           *                     using short address  
    234           *
    235           * @return     MAC_SUCCESS or MAC_INVALID_PARAMETER (address to be deleted 
    236           *                  cannot be found in the source address table).
    237           */
    238          uint8 MAC_SrcMatchDeleteEntry ( sAddr_t *addr, uint16 panID  )
    239          {
    240            uint8 index;
    241            
    242            if ( addr == NULL || addr->addrMode != macSrcMatchAddrMode )
    243            {
    244              return MAC_INVALID_PARAMETER;  
    245            }
    246            
    247            /* Look up the source address table and find the entry. */
    248            index = macSrcMatchCheckSrcAddr( addr, panID );
    249          
    250            if( index == MAC_SRCMATCH_INVALID_INDEX )
    251            {
    252              return MAC_INVALID_PARAMETER; 
    253            }
    254            
    255            /* Clear Src Match enable bits */
    256            macSrcMatchSetEnableBit( index, FALSE );
    257          
    258            return MAC_SUCCESS;
    259          }
    260                            
    261          /*********************************************************************
    262           * @fn          MAC_SrcMatchAckAllPending
    263           *
    264           * @brief       Enabled/disable acknowledging all packets with pending bit set
    265           *              The application normally enables it when adding new entries to 
    266           *              the source address table fails due to the table is full, or 
    267           *              disables it when more entries are deleted and the table has
    268           *              empty slots.
    269           *
    270           * @param       option - TRUE (acknowledging all packets with pending field set)
    271           *                       FALSE (acknowledging all packets with pending field cleared) 
    272           *
    273           * @return      none
    274           */
    275          void MAC_SrcMatchAckAllPending ( uint8 option  ) 
    276          {
    277            if( option == TRUE )
    278            {
    279              macSrcMatchIsAckAllPending = TRUE;
    280              
    281              /* Set the PENDING_OR register */
    282              MAC_RADIO_TURN_ON_PENDING_OR();
    283            }
    284            else
    285            {
    286              macSrcMatchIsAckAllPending = FALSE;
    287              
    288              /* Clear the PENDING_OR register */
    289              MAC_RADIO_TURN_OFF_PENDING_OR();
    290            }
    291          }
    292          
    293          /*********************************************************************
    294           * @fn          MAC_SrcMatchCheckAllPending
    295           *
    296           * @brief       Check if acknowledging all packets with pending bit set
    297           *              is enabled. 
    298           *
    299           * @param       none 
    300           *
    301           * @return      MAC_AUTOACK_PENDING_ALL_ON or MAC_AUTOACK_PENDING_ALL_OFF
    302           */
    303          uint8 MAC_SrcMatchCheckAllPending ( void )
    304          {
    305            if( macSrcMatchIsAckAllPending == TRUE )
    306            {
    307              return MAC_AUTOACK_PENDING_ALL_ON; 
    308            }
    309            
    310            return MAC_AUTOACK_PENDING_ALL_OFF;
    311          }
    312          
    313          /*********************************************************************
    314           * @fn          MAC_SrcMatchCheckResult
    315           *
    316           * @brief       Check the result of source matching
    317           *
    318           * @param       index - index of the entry in the source address table
    319           *
    320           * @return      TRUE or FALSE
    321           */
    322          MAC_INTERNAL_API bool MAC_SrcMatchCheckResult( void )
    323          {
    324            uint8 resIndex;
    325            
    326            if ( macSrcMatchIsAckAllPending )
    327            {
    328              return (TRUE);
    329            }
    330            
    331            MAC_RADIO_SRC_MATCH_RESINDEX( resIndex );
    332            
    333            return ( resIndex & AUTOPEND_RES );
    334          }
    335          
    336          /*********************************************************************
    337           * @fn          macSrcMatchFindEmptyEntry
    338           *
    339           * @brief       return index of the first empty entry found
    340           *
    341           * @param       none
    342           *
    343           * @return      uint8 - return index of the first empty entry found
    344           */
    345          static uint8 macSrcMatchFindEmptyEntry( void )
    346          {
    347            uint8  index;
    348            uint24 enable;
    349               
    350            enable = MAC_RADIO_SRC_MATCH_GET_EN();
    351                  
    352            if( macSrcMatchAddrMode == SADDR_MODE_SHORT )
    353            {
    354              for( index = 0; index < macSrcMatchMaxNumEntries; index++ )
    355              {  
    356                if( ( enable & ( (uint24)0x01 << index ) ) == 0 )
    357                {
    358                  return index;
    359                }
    360              }
    361            }
    362            else
    363            {
    364              for( index = 0; index < macSrcMatchMaxNumEntries; index++ )
    365              {  
    366                if( ( enable & ( (uint24)0x01 << ( index * 2 ) ) ) == 0 )
    367                {
    368                  return index;
    369                }
    370              }
    371            }
    372            
    373            /* 
    374             The value of index shall be macSrcMatchMaxNumEntries when it executes
    375             here. The table is full.
    376            */
    377            return index;
    378          }
    379          
    380          /*********************************************************************
    381           * @fn         macSrcMatchCheckSrcAddr
    382           *
    383           * @brief      Check if a short or extended address is in the source address table.
    384           *             This function shall not be called from ISR. It is not thread safe.
    385           *
    386           * @param      addr - a pointer to sAddr_t which contains addrMode 
    387           *                    and a union of a short 16-bit MAC address or an extended 
    388           *                    64-bit MAC address to be checked in the source address table. 
    389           * @param      panID - the device PAN ID. It is only used when the addr is 
    390           *                     using short address 
    391          
    392           * @return     uint8 - index of the entry in the table. Return 
    393           *                     MAC_SRCMATCH_INVALID_INDEX (0xFF) if address not found.
    394           */
    395          static uint8 macSrcMatchCheckSrcAddr ( sAddr_t *addr, uint16 panID  )
    396          {
    397            uint8 index;     
    398            uint8 *pAddr;
    399            uint8 entrySize;
    400            uint8 entry[MAC_SRCMATCH_SHORT_ENTRY_SIZE];  
    401            uint8 ramEntry[MAC_SRCMATCH_EXT_ENTRY_SIZE];
    402                
    403            /*
    404             Currently, shadow memory is not supported to optimize SPI traffic.
    405            */
    406            
    407            if( macSrcMatchAddrMode == SADDR_MODE_SHORT )
    408            {
    409              entry[0] = LO_UINT16( panID );  /* Little Endian for the radio RAM */
    410              entry[1] = HI_UINT16( panID );
    411              entry[2] = LO_UINT16( addr->addr.shortAddr );
    412              entry[3] = HI_UINT16( addr->addr.shortAddr );
    413              pAddr = entry;
    414              entrySize = MAC_SRCMATCH_SHORT_ENTRY_SIZE;
    415            }
    416            else
    417            {
    418              pAddr = addr->addr.extAddr;
    419              entrySize = MAC_SRCMATCH_EXT_ENTRY_SIZE;
    420            }
    421            
    422            for( index = 0; index < macSrcMatchMaxNumEntries; index++ )
    423            {
    424              /* Check if the entry is enabled */
    425              if( macSrcMatchCheckEnableBit( index ) == FALSE )
    426              {
    427                continue; 
    428              }
    429                
    430              /* Compare the short address and pan ID */
    431              MAC_RADIO_SRC_MATCH_TABLE_READ( ( index * entrySize ), ramEntry, entrySize );
    432               
    433              if( osal_memcmp( pAddr, ramEntry, entrySize ) == TRUE )
    434              {
    435                /* Match found */
    436                return index;
    437              }
    438            }
    439            
    440            return MAC_SRCMATCH_INVALID_INDEX;
    441          }
    442          
    443          /*********************************************************************
    444           * @fn          macSrcMatchSetPendEnBit
    445           *
    446           * @brief       Set the enable bit in the source address table
    447           *
    448           * @param       index - index of the entry in the source address table
    449           *
    450           * @return      none
    451           */
    452          static void macSrcMatchSetPendEnBit( uint8 index )
    453          {
    454            uint24 enable;
    455            uint8 buf[MAC_SRCMATCH_ENABLE_BITMAP_LEN];
    456                 
    457            enable = MAC_RADIO_SRC_MATCH_GET_PENDEN(); 
    458                
    459            if( macSrcMatchAddrMode == SADDR_MODE_SHORT )
    460            {
    461              enable |= ( (uint24)0x01 << index );
    462              osal_buffer_uint24( buf, enable );
    463              MAC_RADIO_SRC_MATCH_SET_SHORTPENDEN( buf );
    464            }
    465            else
    466            {
    467              enable |= ( (uint24)0x01 << ( index * 2 ) );
    468              osal_buffer_uint24( buf, enable );
    469              MAC_RADIO_SRC_MATCH_SET_EXTPENDEN( buf );
    470            }
    471          }
    472          
    473          /*********************************************************************
    474           * @fn          macSrcMatchSetEnableBit
    475           *
    476           * @brief       Set or clear the enable bit in the SRCMATCH EN register
    477           *
    478           * @param       index - index of the entry in the source address table
    479           * @param       option - true (set the enable bit), or false (clear the enable bit)
    480           *
    481           * @return      none
    482           */
    483          static void macSrcMatchSetEnableBit( uint8 index, bool option )
    484          {
    485            uint24 enable;  
    486            
    487            enable = MAC_RADIO_SRC_MATCH_GET_EN(); 
    488                
    489            if( option == TRUE )
    490            {
    491              if( macSrcMatchAddrMode == SADDR_MODE_SHORT )
    492              {
    493                enable |= ( (uint24)0x01 << index );
    494                MAC_RADIO_SRC_MATCH_SET_SHORTEN( enable );
    495              }
    496              else
    497              {
    498                enable |= ( (uint24)0x01 << ( index * 2 ) );
    499                MAC_RADIO_SRC_MATCH_SET_EXTEN( enable );
    500              }
    501            }
    502            else
    503            {
    504              if( macSrcMatchAddrMode == SADDR_MODE_SHORT )
    505              {
    506                enable &= ~( (uint24)0x01 << index );
    507                MAC_RADIO_SRC_MATCH_SET_SHORTEN( enable );
    508              }
    509              else
    510              {
    511                enable &= ~( (uint24)0x01 << ( index * 2 ) );
    512                MAC_RADIO_SRC_MATCH_SET_EXTEN( enable );
    513              }
    514            }
    515          }
    516          
    517          /*********************************************************************
    518           * @fn          macSrcMatchCheckEnableBit
    519           *
    520           * @brief       Check the enable bit in the source address table
    521           *
    522           * @param       index - index of the entry in the source address table
    523           *
    524           * @return      TRUE or FALSE
    525           */
    526          static bool macSrcMatchCheckEnableBit( uint8 index )
    527          {
    528            uint24 enable;
    529            
    530            if( macSrcMatchAddrMode == SADDR_MODE_EXT )
    531            {
    532              index *= 2;
    533            }
    534            
    535            enable = MAC_RADIO_SRC_MATCH_GET_EN();
    536               
    537            if( enable & ( (uint24)0x01 << index ) )
    538            {
    539              return TRUE;
    540            }
    541          
    542            return FALSE; 
    543          }
    544           
    545          /*********************************************************************
    546           * @fn          macSrcMatchGetEnableBit
    547           *
    548           * @brief       Return the SRCMATCH enable bitmap
    549           *
    550           * @param       none
    551           *
    552           * @return      uint24 - 24 bits bitmap
    553           */
    554          static uint24 macSrcMatchGetEnableBit( void )
    555          { 
    556            uint8 buf[MAC_SRCMATCH_ENABLE_BITMAP_LEN];
    557            
    558            if( macSrcMatchAddrMode == SADDR_MODE_SHORT )
    559            {
    560              MAC_RADIO_GET_SRC_SHORTEN( buf );
    561            }
    562            else
    563            {
    564              MAC_RADIO_GET_SRC_EXTEN( buf );
    565            }
    566            
    567            return osal_build_uint32( buf, MAC_SRCMATCH_ENABLE_BITMAP_LEN );
    568          }
    569          
    570          /*********************************************************************
    571           * @fn          macSrcMatchGetPendEnBit
    572           *
    573           * @brief       Return the SRCMATCH Pend enable bitmap
    574           *
    575           * @param       none
    576           *
    577           * @return      uint24 - 24 bits bitmap
    578           */
    579          static uint24 macSrcMatchGetPendEnBit( void )
    580          {
    581            uint8 buf[MAC_SRCMATCH_ENABLE_BITMAP_LEN];
    582          
    583            if( macSrcMatchAddrMode == SADDR_MODE_SHORT )
    584            {
    585              MAC_RADIO_GET_SRC_SHORTPENDEN( buf );
    586            }
    587            else
    588            {
    589              MAC_RADIO_GET_SRC_EXTENPEND( buf );
    590            }
    591            
    592            return osal_build_uint32( buf, MAC_SRCMATCH_ENABLE_BITMAP_LEN );
    593          }
    594          
    595          

   Maximum stack usage in bytes:

     Function                       ISTACK PSTACK XSTACK
     --------                       ------ ------ ------
     MAC_SrcMatchAckAllPending          2      0      0
     MAC_SrcMatchAddEntry               1      0     15
       -> macSrcMatchCheckSrcAddr       0      0     30
       -> macSrcMatchFindEmptyEntry     0      0     30
       -> macMemWriteRam                0      0     30
       -> macMemWriteRam                0      0     30
       -> macSrcMatchSetPendEnBit       0      0     30
       -> macSrcMatchSetEnableBit       0      0     30
     MAC_SrcMatchCheckAllPending        2      0      0
     MAC_SrcMatchCheckResult            2      0      0
     MAC_SrcMatchDeleteEntry            0      0      9
       -> macSrcMatchCheckSrcAddr       0      0     18
       -> macSrcMatchSetEnableBit       0      0     18
     MAC_SrcMatchEnable                 2      0      0
     macSrcMatchCheckEnableBit          0      0     40
       -> macSrcMatchGetEnableBit       0      0     32
     macSrcMatchCheckSrcAddr            1      0     41
       -> macSrcMatchCheckEnableBit     0      0     48
       -> macMemReadRam                 0      0     48
       -> osal_memcmp                   0      0     52
     macSrcMatchFindEmptyEntry          1      0     35
       -> macSrcMatchGetEnableBit       0      0     40
     macSrcMatchGetEnableBit            2      0     23
       -> macMemReadRam                 4      0      6
       -> macMemReadRam                 4      0      6
       -> osal_build_uint32             4      0      6
     macSrcMatchGetPendEnBit            2      0     22
       -> macMemReadRam                 4      0      6
       -> macMemReadRam                 4      0      6
       -> osal_build_uint32             4      0      6
     macSrcMatchSetEnableBit            0      0     35
       -> macSrcMatchGetEnableBit       0      0     32
       -> osal_buffer_uint24            0      0     40
       -> osal_buffer_uint24            0      0     40
       -> osal_buffer_uint24            0      0     40
       -> osal_buffer_uint24            0      0     40
     macSrcMatchSetPendEnBit            0      0     38
       -> macSrcMatchGetPendEnBit       0      0     38
       -> osal_buffer_uint24            0      0     46
       -> macMemWriteRam                0      0     38
       -> osal_buffer_uint24            0      0     46
       -> macMemWriteRam                0      0     38


   Segment part sizes:

     Function/Label                         Bytes
     --------------                         -----
     macSrcMatchIsEnabled                      1
     macSrcMatchMaxNumEntries                  1
     macSrcMatchAddrMode                       1
     macSrcMatchIsAckAllPending                1
     MAC_SrcMatchEnable                       83
     ??Subroutine2_0                           7
     MAC_SrcMatchAddEntry                    219
     MAC_SrcMatchDeleteEntry                  56
     MAC_SrcMatchAckAllPending                37
     MAC_SrcMatchCheckAllPending              20
     MAC_SrcMatchCheckResult                  25
     macSrcMatchFindEmptyEntry               147
     macSrcMatchCheckSrcAddr                 195
     macSrcMatchSetPendEnBit                 152
     ?Subroutine1                              3
     ??Subroutine3_0                           5
     macSrcMatchSetEnableBit                 158
     macSrcMatchCheckEnableBit                74
     ?Subroutine0                             25
     macSrcMatchGetEnableBit                  38
     macSrcMatchGetPendEnBit                  38
     ?<Initializer for macSrcMatchAddrMode>    1
     __Constant_0                              4
     ??MAC_SrcMatchEnable?relay                6
     ??MAC_SrcMatchAddEntry?relay              6
     ??MAC_SrcMatchDeleteEntry?relay           6
     ??MAC_SrcMatchAckAllPending?relay         6
     ??MAC_SrcMatchCheckAllPending?relay       6
     ??MAC_SrcMatchCheckResult?relay           6
     ??macSrcMatchFindEmptyEntry?relay         6
     ??macSrcMatchCheckSrcAddr?relay           6
     ??macSrcMatchSetPendEnBit?relay           6
     ??macSrcMatchSetEnableBit?relay           6
     ??macSrcMatchCheckEnableBit?relay         6
     ??macSrcMatchGetEnableBit?relay           6
     ??macSrcMatchGetPendEnBit?relay           6

 
 1 282 bytes in segment BANKED_CODE
    78 bytes in segment BANK_RELAYS
     1 byte  in segment XDATA_I
     1 byte  in segment XDATA_ID
     4 bytes in segment XDATA_ROM_C
     3 bytes in segment XDATA_Z
 
 1 361 bytes of CODE  memory
     0 bytes of CONST memory (+ 4 bytes shared)
     4 bytes of XDATA memory

Errors: none
Warnings: none
